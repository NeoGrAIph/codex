# Native-first audit: rust-v0.98.0 vs fork/colab-agents

> Owner: <team/owner> | Scope: fork/colab-agents upgrade audit | Audience: devs
> Status: draft | Last reviewed: 2026-02-06 | Related: `docs/fork/release-audit/0.98/REPORT.md`

## Цель

- Зафиксировать отличия между upstream `rust-v0.98.0` (commit `82464689c…`) и форком `fork/colab-agents`
  (baseline commit `33aa00c7f…`).
- Сделать **native-first аудит**: найти места, где форк добавляет кастом, но в upstream уже есть равный/лучший
  нативный аналог (или появился более простой путь), и сформировать рекомендации по дефоркизации.

## Артефакты diff (источник правды)

- Baseline: `docs/fork/release-audit/0.98/DIFF_BASELINE.md`
- Index: `docs/fork/release-audit/0.98/DIFF_INDEX.md`
- Per-file patches: `docs/fork/release-audit/0.98/diff/*.patch`

Примечание: ветка `fork/colab-agents` двигается (в т.ч. коммиты аудита), но артефакты pinned к baseline commit
`33aa00c7f…`.

## Инвентарь (triage)

Категоризация берётся из `DIFF_INDEX.md` (эвристика для маршрутизации review; при необходимости можно уточнять).

| Category | Count | Notes |
|---|---:|---|
| core | 171 | По умолчанию: `codex-rs/**` вне явных special-case категорий |
| generated | 71 | Schema/config/lock и др. артефакты, не аудитим построчно |
| tui | 65 | `codex-rs/tui/**` и снапшоты |
| vendor | 50 | `codex-rs/vendor/**` (не аудитим построчно) |
| docs | 15 | `docs/**` + `AGENTS.md` |
| protocol | 8 | `codex-rs/protocol/**` + `codex-rs/app-server-protocol/src/**` (schema исключена) |
| ci | 7 | `.github/**`, `scripts/**` |
| linux-sandbox | 3 | `codex-rs/linux-sandbox/**` |

### Status breakdown

| Status | Count |
|---:|---:|
| M | 277 |
| D | 82 |
| A | 26 |
| R | 5 |

## Coverage gaps (TODO triage)

Эти подсекции присутствуют в `DIFF_INDEX.md`, но в текущем проходе **не разобраны карточками** (требуется отдельный
triage, иначе финальный риск-профиль неполный):

- `codex-rs/codex-api/**` (24)
- `codex-rs/app-server/**` (15)
- `codex-rs/windows-sandbox-rs/**` (11)
- `codex-rs/mcp-server/**` (6)
- `codex-rs/exec/**` (5)
- `codex-rs/state/**` (4)
- `codex-rs/otel/**` (4)
- `codex-rs/secrets/**` (3)
- `codex-rs/app-server-test-client/**` (3)

## Формат карточек

Определения:

- **Native-first assessment**: есть ли в upstream нативный эквивалент/замена fork-кастому (или более правильный
  API/паттерн), и насколько он покрывает fork use-case.
- **Priority**:
  - **P0**: блокер апгрейда/безопасности/данных или высокий риск регрессий; исправлять в первую очередь.
  - **P1**: важно для поддерживаемости/UX/снижения диффа, но не блокер.
  - **P2**: nice-to-have, можно отложить.

Правила:

- Не вставлять большие диффы сюда; ссылаться на `.patch` из `docs/fork/release-audit/0.98/diff/…`.
- `generated/vendor` не аудитим построчно: фиксируем только риски и правила регенерации.
- Generated artifacts verification (do not review line-by-line):
- `app-server-protocol/schema/**`: `just write-app-server-schema` (diff должен совпасть).
- `core/config.schema.json`: `just write-config-schema`.
- `Cargo.lock`: обновляется только через Cargo; подтверждать сборкой/тестами, а не построчным ревью.

## Карточки (native-first)

### Core

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-CORE-001 | core | [model_provider_info.rs.patch](release-audit/0.98/diff/codex-rs_core_src_model_provider_info.rs.patch)<br>[client.rs.patch](release-audit/0.98/diff/codex-rs_core_src_client.rs.patch)<br>[tools_spec.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_spec.rs.patch)<br>[codex.rs.patch](release-audit/0.98/diff/codex-rs_core_src_codex.rs.patch) | Fork ре-интегрирует `WireApi::Chat` (chat completions), меняет default wire_api, добавляет отдельный streaming-путь и конвертацию tools JSON под chat API, плюс deprecation notice | Upstream 0.98 intentionally удалил/запретил chat-wire; native-first = придерживаться Responses-only (или отдельный adapter-слой вне core) | Либо план миграции на Responses и удаление Chat-пути, либо жёстко ограничить Chat только для конкретных OSS-провайдеров (без смены дефолтов) | P0 | Высокий риск расхождения поведения/тестов с upstream; совместимость с провайдерами/локальными моделями требует ручного подтверждения |
| NF-CORE-007 | core | [exec_policy.rs.patch](release-audit/0.98/diff/codex-rs_core_src_exec_policy.rs.patch) | Exec-policy теперь читает `.codex/rules` даже из trust-disabled project layers (раньше игнорировалось) | Upstream делает безопаснее (не доверяет rules из недоверенных слоёв); native-first = upstream поведение | Вернуть upstream (игнор disabled/untrusted) либо минимум: разрешать только “forbid” из disabled layers (никогда “allow”) + тесты | P0 | Потенциальный security bypass/поведенческий сюрприз; требует явной фиксации модели доверия для `.codex/rules` |
| NF-CORE-008 | core | [config_requirements.rs.patch](release-audit/0.98/diff/codex-rs_core_src_config_loader_config_requirements.rs.patch)<br>[config/mod.rs.patch](release-audit/0.98/diff/codex-rs_core_src_config_mod.rs.patch) | Ослабление requirements constraints: убран `ConstrainedWithSource` (теряется provenance), и в `Config` убрана логика fallback на requirement-default при неявных значениях | Upstream-native лучше для объяснимости и enforcement; fork меняет safety-инварианты | Вернуть upstream enforcement + source-tracking (или эквивалент), чтобы requirements реально ограничивали дефолты/авто-режимы | P0 | Риск нарушения корпоративных/облачных требований (approval/sandbox/residency) |
| NF-CORE-002 | core | [agent_registry.rs.patch](release-audit/0.98/diff/codex-rs_core_src_agent_registry.rs.patch)<br>[agent_role.rs.patch](release-audit/0.98/diff/codex-rs_core_src_agent_role.rs.patch)<br>[codex.rs.patch](release-audit/0.98/diff/codex-rs_core_src_codex.rs.patch) | Большая fork-система “agent registry” (загрузка `.codex/agents/*.md` с YAML frontmatter, seeding builtin agents, расширенные роли/инструкции) | Upstream-native эквивалента в 0.98 нет; это fork-only функциональность | KEEP (fork-only), но изолировать точки интеграции/контракты и держать совместимость с upstream коллаб-режимами | P1 | Риск поддерживаемости (много нового кода в core); вероятны конфликты при следующих апгрейдах |
| NF-CORE-003 | core | [collab.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_handlers_collab.rs.patch)<br>[tools_spec.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_spec.rs.patch) | `spawn_agent`: вместо enum-role — `agent_type`/`agent_name` из registry + model/reasoning overrides + фоновые статус-ивенты/relay | Upstream-native spawn_agent проще; fork расширения полезны, но увеличивают divergence | KEEP, но минимизировать payload-расширения до совместимых полей; overrides держать в policy/config | P1 | Риски: совместимость протокола/ивентов, стабильность UI/клиентов |
| NF-CORE-004 | core | [config/mod.rs.patch](release-audit/0.98/diff/codex-rs_core_src_config_mod.rs.patch)<br>[tool_allowlist.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tool_allowlist.rs.patch)<br>[tools_spec.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_spec.rs.patch)<br>[tools_registry.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_registry.rs.patch) | Tool allowlist/denylist (wildmatch), фильтрация registry/specs, “policy floor” для spawned agents | Upstream-native механизма нет; но концепт близок к upstream security posture | KEEP, но оформить как upstream-совместимую policy-модель (без завязки на registry) и документировать как security feature | P1 | Риск неожиданных пустых toolset’ов; нужно покрыть тестами комбинации allow/deny + agent profiles |
| NF-CORE-006 | core | [skills_remote.rs.patch](release-audit/0.98/diff/codex-rs_core_src_skills_remote.rs.patch)<br>[skills/mod.rs.patch](release-audit/0.98/diff/codex-rs_core_src_skills_mod.rs.patch) | Удалён remote skills downloader (сетевые запросы) | Upstream-native фича конфликтует с sandbox/network ограничениями; fork более безопасен | KEEP (fork-only): либо полностью отключено, либо возвращать только за явным флагом/feature и с явной моделью угроз | P1 | Риск потери функционала upstream; нужно подтвердить, что продукт не зависит от remote skills |
| NF-CORE-009 | core | [models_manager/manager.rs.patch](release-audit/0.98/diff/codex-rs_core_src_models_manager_manager.rs.patch)<br>[models_manager/model_info.rs.patch](release-audit/0.98/diff/codex-rs_core_src_models_manager_model_info.rs.patch) | Fork добавляет `experimental_supported_tools` (read_file/list_dir/grep_files) в локальные model defaults и “backfill” при пустых remote-данных | Upstream-native источник истины = remote model metadata; fork костыль компенсирует неполные remote ответы | Держать временно, но стремиться к upstream-native: починить/дождаться remote metadata и удалить backfill | P1 | Риск дрейфа: локальные дефолты могут не совпадать с реальными capabilities модели |
| NF-CORE-012 | core | [rollout/list.rs.patch](release-audit/0.98/diff/codex-rs_core_src_rollout_list.rs.patch)<br>[state_db.rs.patch](release-audit/0.98/diff/codex-rs_core_src_state_db.rs.patch) | Rollout/thread lookup: перестали предпочитать SQLite DB; файловый поиск стал canonical, а DB используется для parity-check и warning-ов | Upstream-native упирает на DB-ускорение; fork-дельта повышает корректность при stale DB ценой возможной деградации perf | Определить канонический источник истины (FS vs DB) и закрепить это тестами/метриками; если DB должен быть каноничным — вернуть upstream путь после стабилизации миграции | P1 | Риск: perf регрессия при листинге/поиске threads; “шумные” предупреждения о mismatch |
| NF-CORE-005 | core | [agents.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_handlers_agents.rs.patch)<br>[agent_tools.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_spec_agent_tools.rs.patch)<br>[handlers/mod.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_handlers_mod.rs.patch) | Новые tools: `list_agents`/`read_agent` (доступ к локальному registry из модели) | Upstream-native можно было бы заменить “read_file + conventions”, но tool-API безопаснее/структурнее | KEEP (fork-only) как thin-layer над registry | P2 | Риск раскрытия инструкций (ожидаемо); уточнить политику scope (system/user/project) |
| NF-CORE-013 | core | [apply_patch runtime.patch](release-audit/0.98/diff/codex-rs_core_src_tools_runtimes_apply_patch.rs.patch) | `apply_patch` runtime теперь резолвит “invoker” бинарь (codex vs apply_patch) по `codex_exe` и окружению (в т.ч. когда invoker = `codex-linux-sandbox`) | Upstream-native чаще полагается на `current_exe`; fork-дельта выглядит как robustness fix для sandboxed окружений | KEEP; добавить регрессионные тесты на резолвинг invoker (особенно для `codex-linux-sandbox` и Windows) | P2 | Риск: tool может не запускаться при нестандартной раскладке бинарей; важно, чтобы резолвинг не позволял подмену запускаемого exe |
| NF-CORE-010 | core | [mcp_connection_manager.rs.patch](release-audit/0.98/diff/codex-rs_core_src_mcp_connection_manager.rs.patch) | Не блокировать `list_all_tools()` на старте `codex_apps_mcp` (используется `now_or_never`) | Upstream-native должен решать readiness/таймаутами, а не специальным кейсом | Либо upstream fix, либо общий механизм “soft readiness” для MCP клиентов | P2 | Риск: tools могут “пропадать” на ранних запросах; проверить наличие retry/refresh пути |
| NF-CORE-011 | core | [exec_env.rs.patch](release-audit/0.98/diff/codex-rs_core_src_exec_env.rs.patch) | Убран инжект `CODEX_THREAD_ID` в env для shell | Upstream-native может использовать это для трассировки/аудита; fork уменьшает утечки контекста в subprocess | Подтвердить, что thread-id не нужен downstream; иначе заменить upstream-native способом (structured logging/headers), не env | P2 | Риск потери корреляции в логах/скриптах |

### TUI

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-TUI-003 | tui | [streaming/mod.rs](release-audit/0.98/diff/codex-rs_tui_src_streaming_mod.rs.patch) [streaming/controller.rs](release-audit/0.98/diff/codex-rs_tui_src_streaming_controller.rs.patch) [D streaming/chunking.rs](release-audit/0.98/diff/codex-rs_tui_src_streaming_chunking.rs.patch) [D streaming/commit_tick.rs](release-audit/0.98/diff/codex-rs_tui_src_streaming_commit_tick.rs.patch) [chatwidget.rs](release-audit/0.98/diff/codex-rs_tui_src_chatwidget.rs.patch) | Убраны upstream adaptive chunking + commit_tick orchestration (queue timestamps, catch-up draining), commit tick упрощён до “1 line per tick” для stream+plan | Fork-дельта выглядит removable (upstream реализация богаче и снижает лаг при bursty output) | Native-first кандидат: вернуть upstream chunking/commit_tick и интеграцию с ChatWidget | P0 | Заметные UX/снапшот-изменения; тестить длинные стримы, backlog, plan+ответ одновременно |
| NF-TUI-001 | tui | [app.rs](release-audit/0.98/diff/codex-rs_tui_src_app.rs.patch) [app_backtrack.rs](release-audit/0.98/diff/codex-rs_tui_src_app_backtrack.rs.patch) [bottom_pane/footer.rs](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_footer.rs.patch) [footer shortcuts snap](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_snapshots_codex_tui_bottom_pane_footer_tests_footer_shortcuts_collaboration_modes_enabled.snap.patch) [collab.rs](release-audit/0.98/diff/codex-rs_tui_src_collab.rs.patch) | Multi-agent overlay: трекинг sub-agent threads, вывод summary/details, хоткей Ctrl+N (цикл summary→details→close), Ctrl+T оставлен под transcript pager | Upstream такого UI нет → убрать можно только ценой потери fork-ключевой фичи | Оставить fork-дельту; следить за конфликтами хоткеев/alt-screen и за флагом collaboration | P1 | Риск: сложность и “липкое” состояние overlay; проверить alt-screen + закрытие overlay в backtrack/preview режимах |
| NF-TUI-002 | tui | [chatwidget.rs](release-audit/0.98/diff/codex-rs_tui_src_chatwidget.rs.patch) [chatwidget/tests.rs](release-audit/0.98/diff/codex-rs_tui_src_chatwidget_tests.rs.patch) | Collaboration modes стартуют как `ModeKind::Custom` (инертно); не применяется upstream default preset/mask и не отправляется mode, пока юзер явно не выберет | Fork-отклонение от upstream поведения; потенциально можно вернуть native/upstream | Решение продуктовое: вернуть upstream default или оставить fork “не менять поведение молча” и явно подсветить выбор режима в UI | P1 | Риск: пользователю кажется, что collaboration modes “не работают” после включения |
| NF-TUI-006 | tui | [oss_selection.rs](release-audit/0.98/diff/codex-rs_tui_src_oss_selection.rs.patch) [tui/lib.rs](release-audit/0.98/diff/codex-rs_tui_src_lib.rs.patch) [app.rs](release-audit/0.98/diff/codex-rs_tui_src_app.rs.patch) | OSS UX: добавлен провайдер “Ollama (chat)” (клавиша `c`), плюс детект/показ deprecation notice | Upstream этого не имеет; fork-функциональность завязана на fork OSS provider’ы | Оставить fork-дельту; при появлении upstream аналога — переехать на upstream API/тексты | P1 | Риск: детект может флапать/ошибаться; проверить отсутствие сетевых зависимостей и корректный показ notice |
| NF-TUI-004 | tui | [tui/frame_rate_limiter.rs](release-audit/0.98/diff/codex-rs_tui_src_tui_frame_rate_limiter.rs.patch) [tui/frame_requester.rs](release-audit/0.98/diff/codex-rs_tui_src_tui_frame_requester.rs.patch) [pager_overlay.rs](release-audit/0.98/diff/codex-rs_tui_src_pager_overlay.rs.patch) [tui.rs](release-audit/0.98/diff/codex-rs_tui_src_tui.rs.patch) | Frame pacing: clamp 60 FPS (вместо 120), pager overlay просит кадр через 16ms, удалён TARGET_FRAME_INTERVAL | Потенциально можно вернуться к upstream константе/120fps ради снижения расхождений | Если нет измеримой пользы 60fps — откатиться к upstream; иначе оставить, но привязать к общей константе | P2 | Влияет на “ощущение” стриминга/скролла и на CPU; проверка должна быть ручной |
| NF-TUI-005 | tui | [request_user_input/mod.rs](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_request_user_input_mod.rs.patch) [request_user_input snap](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_request_user_input_snapshots_codex_tui_bottom_pane_request_user_input_tests_request_user_input_options_notes_visible.snap.patch) | UX/hotkeys: Esc в notes-mode теперь всегда `Interrupt` (раньше: “очистить notes и вернуться к options”), Tab очищает notes только при фокусе в notes | Upstream поведение можно вернуть, но fork-изменение кажется более консистентным с “Esc to interrupt” | Оставить fork (если цель — единый Esc=interrupt); иначе вернуть upstream “Esc cancels notes” и поправить подсказки | P2 | Риск: Esc может неожиданно прервать turn и потерять draft; обязательно проверить multi-question + notes |
| NF-TUI-007 | tui | [status/helpers.rs](release-audit/0.98/diff/codex-rs_tui_src_status_helpers.rs.patch) [status/card.rs](release-audit/0.98/diff/codex-rs_tui_src_status_card.rs.patch) [bottom_pane/footer.rs](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_footer.rs.patch) | History/status/footer: цветной индикатор “% context left” (red<15/yellow<30) | Можно убрать ради native-first (upstream проще), но дельта малорисковая и улучшает UX | Оставить как fork-улучшение, если принимаем визуальную семантику; иначе откатить к upstream строкам | P2 | Риск: доступность/темы терминала; снапшоты чувствительны к форматированию |
| NF-TUI-008 | tui | [cli.rs](release-audit/0.98/diff/codex-rs_tui_src_cli.rs.patch) [history_cell.rs](release-audit/0.98/diff/codex-rs_tui_src_history_cell.rs.patch) [status/card.rs](release-audit/0.98/diff/codex-rs_tui_src_status_card.rs.patch) [update_prompt.rs](release-audit/0.98/diff/codex-rs_tui_src_update_prompt.rs.patch) [resume_picker.rs](release-audit/0.98/diff/codex-rs_tui_src_resume_picker.rs.patch) | Форк-брендинг версии: “FN” префиксы/суффиксы в CLI/help, status card, update prompt, history cells, тестах | Это сознательная fork-идентификация; native-first откат возможен, но тогда теряется различимость | Оставить; унифицировать формат (префикс/суффикс без лишних пробелов) при следующих правках | P2 | Риск: строки версии могут парситься внешними тулзами/тестами; снапшоты чувствительны |
| NF-TUI-009 | tui | [debug_config.rs](release-audit/0.98/diff/codex-rs_tui_src_debug_config.rs.patch) | Debug config: для ряда требований больше не показывается “source” (становится `<unspecified>`), тесты переписаны | Убрать дельту можно только если core снова несёт source-метаданные; иначе это вынужденная адаптация | Оставить как совместимость с fork-core; рассмотреть возврат source при восстановлении API в core | P2 | Риск: ухудшение диагностичности |
| NF-TUI-010 | tui | [history_cell.rs](release-audit/0.98/diff/codex-rs_tui_src_history_cell.rs.patch) | Runtime metrics: убраны строки “Responses API overhead/inference” из separator label | Похоже removable: upstream метрики полезны, если в fork они корректны | Решить по факту: вернуть upstream строки или оставить скрытыми (если шумят) | P2 | Риск: потеря observability в UI; проверить наличие метрик в реальных сессиях |

### Protocol

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-PROTO-001 | protocol | [common.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_common.rs.patch)<br>[v2.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_v2.rs.patch)<br>[protocol.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_protocol.rs.patch) | Удалены RPC `skills/remote/*` + `Op::ListRemoteSkills/DownloadRemoteSkill` и соответствующие `EventMsg`/типы | Upstream-native уже покрывает “skills” локально; “remote sharing” лучше делать вне протокола | Зафиксировать удаление; если форку критично “remote skills” — реализовать как клиентский fetch+install без новых публичных RPC | P0 | Breaking для клиентов/SDK, которые вызывали `skills/remote/*` или ждали `ListRemoteSkillsResponse` |
| NF-PROTO-003 | protocol | [export.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_export.rs.patch)<br>[v2.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_v2.rs.patch) | TS-codegen: запрет `?: T | null` (и `| undefined`), массовая правка `#[ts(optional = nullable)]` | Upstream-native: строгий TS-контракт без “optional+nullable” | Принять как базовое правило; точечно решать поля: где реально “можно omit” — переводить в `#[ts(optional)]`, иначе `T | null` | P0 | Возможен компиляционный break для TS-клиентов (теперь многие поля “required, nullable”) |
| NF-PROTO-004 | protocol | [config_types.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_config_types.rs.patch) | `ModeKind`: `Custom` добавлен (FORK), алиасы `pair_programming/execute/custom` больше не мапятся в `Default`; `PairProgramming/Execute` стали сериализуемыми вариантами | Fork-дельта `Custom` в on-wire протоколе часто можно выразить upstream-native через `developer_instructions` без нового `mode` | Не расширять публичный протокол значением `custom`; маппить `Custom` → `Default` на wire и хранить “custom-стейт” локально (UI), либо жёстко gate-ить форк-фичей | P0 | Риск несовместимости с внешними клиентами/хранилищем сессий, если `custom` начнёт сериализоваться наружу |
| NF-PROTO-007 | protocol | [protocol.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_protocol.rs.patch) | SandboxPolicy: `.agents` больше не добавляется в `read_only_subpaths` (остались `.git` и `.codex`) | Fork-специфика: если форк реально использует `.agents/**` для инструкций/skill-asset’ов, upstream-native защита могла быть важна | Либо вернуть `.agents` в read-only (желательно под форк-флагом), либо мигрировать форк-артефакты под `.codex/` | P0 | Потенциальная секьюрити-регрессия: агент сможет писать в `.agents/**` при разрешённой записи в workspace |
| NF-PROTO-002 | protocol | [common.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_common.rs.patch)<br>[v2.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_v2.rs.patch) | Удалён RPC `thread/compact/start` и его Params/Response | “Compaction” уже выражается через существующие события/механику без отдельного старт-метода | Не возвращать отдельный RPC; если нужен “manual compact” — искать upstream-эквивалентный триггер | P1 | Нужно подтвердить, был ли реальный внешний потребитель `thread/compact/start` |
| NF-PROTO-005 | protocol | [config_types.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_config_types.rs.patch)<br>[openai_models.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_openai_models.rs.patch) | Удалён `Personality::None` (теперь “нет personality” выражается отсутствием значения) | Upstream-native: `Option<Personality>` несёт “none” без отдельного enum-варианта | Ок принять; для совместимости конфигов рассмотреть alias/миграцию на уровне парсинга | P1 | Breaking для старых `config.toml`, где было `personality = \"none\"` |
| NF-PROTO-006 | protocol | [protocol.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_protocol.rs.patch) | Добавлены `agent_type/agent_name` в `SubAgentSource::ThreadSpawn` и `CollabAgentSpawnEndEvent` | Native-first: совпадает с upstream-концептом `agent_type/agent_name` в tool schema, улучшает наблюдаемость | Оставить поля опциональными; клиенты должны игнорировать неизвестные поля | P1 | Минимальный wire-риск (поля optional), но нужно проверить все потребители событий/логов |
| NF-PROTO-008 | protocol | [on_request_rule.md.patch](release-audit/0.98/diff/codex-rs_protocol_src_prompts_permissions_approval_policy_on_request_rule.md.patch) | Обновлён текст approval-policy: `prefix_rule` теперь “Suggest …”, переформатирован блок про approved prefixes | Это не протокольное расширение, а правка prompt/инструкций | Принять как doc/prompt-апдейт; проверить, что нет brittle парсинга текста | P2 | Риск только если где-то есть парсинг текста как структуры |

### Linux sandbox

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-LS-001 | linux-sandbox | [exec_policy.rs.patch](release-audit/0.98/diff/codex-rs_core_src_exec_policy.rs.patch) | Форк грузит `.codex/rules` даже из trust-disabled project layer | См. NF-CORE-007 (тот же риск/решение) | См. NF-CORE-007 | P0 | Дубликат карточки NF-CORE-007 (оставлено для маршрутизации sandbox review) |
| NF-LS-003 | linux-sandbox | [linux-sandbox/build.rs.patch](release-audit/0.98/diff/codex-rs_linux-sandbox_build.rs.patch)<br>[linux-sandbox/Cargo.toml.patch](release-audit/0.98/diff/codex-rs_linux-sandbox_Cargo.toml.patch)<br>[vendored bubblewrap patches](release-audit/0.98/diff/codex-rs_vendor_bubblewrap_bubblewrap.c.patch) | Удалён build-time pipeline для vendored bubblewrap (и сам vendor tree), т.е. путь “встроенный bwrap через FFI” фактически исчез | Upstream “vendored bwrap” закрывает use-case воспроизводимости/бандлинга; форк-дельта может превратить `use_bwrap_sandbox` в footgun | Либо вернуть upstream vendored-bwrap pipeline, либо полностью выпилить/задокументировать неработающий bwrap-path и перейти на exec системного `bwrap` с явными проверками наличия | P1 | Риск: при включении bwrap-фичи возможен runtime panic/неработающий sandbox; есть лицензионные/NOTICE аспекты (см. NF-META-005) |
| NF-LS-002 | linux-sandbox | [exec_env.rs.patch](release-audit/0.98/diff/codex-rs_core_src_exec_env.rs.patch)<br>[debug_sandbox.rs.patch](release-audit/0.98/diff/codex-rs_cli_src_debug_sandbox.rs.patch)<br>[landlock.rs test.patch](release-audit/0.98/diff/codex-rs_linux-sandbox_tests_suite_landlock.rs.patch) | Убран `CODEX_THREAD_ID` в env и упрощён `create_env(...)` | Upstream-эквивалент не нужен для sandbox; изменение скорее про “меньше скрытых env” vs корреляция/диагностика | Вернуть upstream-поведение, если thread-id реально нужен; иначе оставить, но зафиксировать в ожиданиях/доках | P2 | Риск: потеря корреляции/диагностики (см. NF-CORE-011) |

### Meta (templates / docs / ci / vendor)

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-META-005 | meta | [bubblewrap.c.patch](release-audit/0.98/diff/codex-rs_vendor_bubblewrap_bubblewrap.c.patch) (и `codex-rs_vendor_bubblewrap_*.patch`) | Удалён целиком `codex-rs/vendor/bubblewrap/**` | Native-first “за” удаление vendoring, но только если сборка/упаковка bwrap больше не завязана на эти исходники и закрыты license/NOTICE обязательства | Перед релизом подтвердить цепочку: как теперь обеспечивается bubblewrap (system dependency vs артефакт) + актуализировать упоминания `vendored` путей в доках/ошибках | P0 | Риск: Linux sandbox bwrap pipeline может сломаться (см. NF-LS-003); лицензионные/NOTICE обязательства; supply-chain |
| NF-META-002 | meta | [codex_architect.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_architect.md.patch) [codex_bug-hunter.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_bug-hunter.md.patch) [codex_explorer.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_explorer.md.patch) [codex_orchestrator.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_orchestrator.md.patch) [codex_reviewer.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_reviewer.md.patch) [codex_worker.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_worker.md.patch) [agents/orchestrator.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_orchestrator.md.patch) | Добавлены “встроенные” профили агентов `codex_*.md` + YAML-frontmatter; `agents/orchestrator.md` получил frontmatter | Зона высокого дрейфа: тексты шаблонов частично дублируют глобальные инструкции; сложно синхронизировать с upstream | Оставить только то, что реально fork-специфично; остальное — ссылками/наследованием, чтобы снизить churn | P1 | Риски: prompt-drift (модели/reasoning/tools), “двойной источник правды” (шаблоны vs AGENTS/docs) |
| NF-META-003 | meta | [experimental_prompt.md.patch](release-audit/0.98/diff/codex-rs_core_templates_collab_experimental_prompt.md.patch) [collaboration_mode_code.md.patch](release-audit/0.98/diff/codex-rs_core_templates_collaboration_mode_code.md.patch) | Существенно расширен runtime prompt про sub-agents; добавлен минимальный `collaboration_mode/code.md` | Native-first: держать runtime prompt максимально upstream-каноничным; fork-дополнения — по минимуму/в отдельной fork-доке | Не наращивать кастомизации; fork-поведение фиксировать в коде/фича-флагах и `docs/fork/*`, а не “много текста” в prompt | P1 | Риск: поведенческие изменения multi-agent режима через контент, сложнее отлаживать регрессии |
| NF-META-001 | meta | [.github templates](release-audit/0.98/diff/R_.github_ISSUE_TEMPLATE_3-cli.yml_TO_.github_ISSUE_TEMPLATE_2-bug-report.yml.patch) | Консолидация issue templates (унификация bug report; переименование VS Code; удаление части шаблонов) | Native-first ок: процессные изменения, низкий риск | Держать; проверить, что нет ссылок/автоматизаций на удалённые шаблоны | P2 | Риск: UX/триаж по лейблам; ссылки в CONTRIBUTING/README (если есть) |
| NF-META-004 | meta | [docs/fork patch](release-audit/0.98/diff/docs_fork_diff-fork-vs-main.md.patch) (и прочие `docs_fork_*.patch`) | Добавлен набор fork-доков (процесс интеграции, аудит diff, список upstream-коммитов и т.п.) | Native-first: возможны дубли и дорогое поддержание больших “дифф-репортов” | Оставить fork-доки, но стремиться к “тонкому слою”: 1 основной документ + ссылки; большие отчёты держать в release-audit/генерации | P2 | Риск: устаревание/рассинхрон; поддержка “тысячи строк” дорогая |
