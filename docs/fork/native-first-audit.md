# Native-first audit: rust-v0.98.0 vs fork/colab-agents

> Owner: <team/owner> | Scope: fork/colab-agents upgrade audit | Audience: devs
> Status: draft | Last reviewed: 2026-02-06 | Related: `docs/fork/release-audit/0.98/REPORT.md`

## Цель

- Зафиксировать отличия между upstream `rust-v0.98.0` (commit `82464689c…`) и форком `fork/colab-agents`
  (baseline commit `33aa00c7f…`).
- Сделать **native-first аудит**: найти места, где форк добавляет кастом, но в upstream уже есть равный/лучший
  нативный аналог (или появился более простой путь), и сформировать рекомендации по дефоркизации.

## Артефакты diff (источник правды)

- Baseline: `docs/fork/release-audit/0.98/DIFF_BASELINE.md`
- Index: `docs/fork/release-audit/0.98/DIFF_INDEX.md`
- Per-file patches: `docs/fork/release-audit/0.98/diff/*.patch`

Примечание: ветка `fork/colab-agents` двигается (в т.ч. коммиты аудита), но артефакты pinned к baseline commit
`33aa00c7f…`.

## Инвентарь (triage)

Категоризация берётся из `DIFF_INDEX.md` (эвристика для маршрутизации review; при необходимости можно уточнять).

| Category | Count | Notes |
|---|---:|---|
| core | 171 | По умолчанию: `codex-rs/**` вне явных special-case категорий |
| generated | 71 | Schema/config/lock и др. артефакты, не аудитим построчно |
| tui | 65 | `codex-rs/tui/**` и снапшоты |
| vendor | 50 | `codex-rs/vendor/**` (не аудитим построчно) |
| docs | 15 | `docs/**` + `AGENTS.md` |
| protocol | 8 | `codex-rs/protocol/**` + `codex-rs/app-server-protocol/src/**` (schema исключена) |
| ci | 7 | `.github/**`, `scripts/**` |
| linux-sandbox | 3 | `codex-rs/linux-sandbox/**` |

### Status breakdown

| Status | Count |
|---:|---:|
| M | 277 |
| D | 82 |
| A | 26 |
| R | 5 |

## Coverage gaps

Закрыто: для крупных подсекций, которые изначально были отмечены как TODO triage, добавлены карточки ниже:

- `codex-rs/codex-api/**`
- `codex-rs/app-server/**`
- `codex-rs/windows-sandbox-rs/**`
- `codex-rs/mcp-server/**`
- `codex-rs/exec/**`
- `codex-rs/state/**`
- `codex-rs/otel/**`
- `codex-rs/secrets/**`
- `codex-rs/app-server-test-client/**`

## Формат карточек

Определения:

- **Native-first assessment**: есть ли в upstream нативный эквивалент/замена fork-кастому (или более правильный
  API/паттерн), и насколько он покрывает fork use-case.
- **Priority**:
  - **P0**: блокер апгрейда/безопасности/данных или высокий риск регрессий; исправлять в первую очередь.
  - **P1**: важно для поддерживаемости/UX/снижения диффа, но не блокер.
  - **P2**: nice-to-have, можно отложить.

Правила:

- Не вставлять большие диффы сюда; ссылаться на `.patch` из `docs/fork/release-audit/0.98/diff/…`.
- `generated/vendor` не аудитим построчно: фиксируем только риски и правила регенерации.
- Generated artifacts verification (do not review line-by-line):
- `app-server-protocol/schema/**`: `just write-app-server-schema` (diff должен совпасть).
- `core/config.schema.json`: `just write-config-schema`.
- `Cargo.lock`: обновляется только через Cargo; подтверждать сборкой/тестами, а не построчным ревью.

## Карточки (native-first)

### Core

D1 (Responses-only): ✅ DONE — `2965b0bca`, `901e3488c`.

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-CORE-001 | core | [model_provider_info.rs.patch](release-audit/0.98/diff/codex-rs_core_src_model_provider_info.rs.patch)<br>[client.rs.patch](release-audit/0.98/diff/codex-rs_core_src_client.rs.patch)<br>[tools_spec.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_spec.rs.patch)<br>[codex.rs.patch](release-audit/0.98/diff/codex-rs_core_src_codex.rs.patch) | ✅ DONE (`2965b0bca`): удалён Chat wire (`WireApi::Chat`), канон/дефолт = Responses-only; `wire_api="chat"` invalid; провайдеры/тесты/фикстуры переведены на Responses SSE | Upstream 0.98 intentionally удалил/запретил chat-wire; native-first = придерживаться Responses-only (или отдельный adapter-слой вне core) | ✅ DONE (`2965b0bca`): Responses-only (upstream) | P0 | Высокий риск расхождения поведения/тестов с upstream снят; совместимость с OSS провайдерами теперь завязана на Responses |
| NF-CORE-007 | core | [exec_policy.rs.patch](release-audit/0.98/diff/codex-rs_core_src_exec_policy.rs.patch) | ✅ DONE (`73681a6e5`, `5ab253881`): exec-policy больше не читает `.codex/rules` из trust-disabled (disabled) project layers | Upstream делает безопаснее (не доверяет rules из недоверенных слоёв); native-first = upstream поведение | ✅ DONE (`73681a6e5`, `5ab253881`) | P0 | Закрыт риск policy bypass через trust-disabled `.codex/rules` |
| NF-CORE-008 | core | [config_requirements.rs.patch](release-audit/0.98/diff/codex-rs_core_src_config_loader_config_requirements.rs.patch)<br>[config/mod.rs.patch](release-audit/0.98/diff/codex-rs_core_src_config_mod.rs.patch) | ✅ DONE (`2107dc485`): восстановлены `ConstrainedWithSource` (provenance) и fallback дефолтов на requirement-default при неявных значениях | Upstream-native лучше для объяснимости и enforcement; fork менял safety-инварианты | ✅ DONE (`2107dc485`) | P0 | Закрыт риск “дефолт нарушает requirements” (hard error вместо fallback) и потеря provenance |
| NF-CORE-002 | core | [agent_registry.rs.patch](release-audit/0.98/diff/codex-rs_core_src_agent_registry.rs.patch)<br>[agent_role.rs.patch](release-audit/0.98/diff/codex-rs_core_src_agent_role.rs.patch)<br>[codex.rs.patch](release-audit/0.98/diff/codex-rs_core_src_codex.rs.patch) | Большая fork-система “agent registry” (загрузка `.codex/agents/*.md` с YAML frontmatter, seeding builtin agents, расширенные роли/инструкции) | Upstream-native эквивалента в 0.98 нет; это fork-only функциональность | KEEP (fork-only), но изолировать точки интеграции/контракты и держать совместимость с upstream коллаб-режимами | P1 | Риск поддерживаемости (много нового кода в core); вероятны конфликты при следующих апгрейдах |
| NF-CORE-003 | core | [collab.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_handlers_collab.rs.patch)<br>[tools_spec.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_spec.rs.patch) | `spawn_agent`: вместо enum-role — `agent_type`/`agent_name` из registry + model/reasoning overrides + фоновые статус-ивенты/relay | Upstream-native spawn_agent проще; fork расширения полезны, но увеличивают divergence | KEEP, но минимизировать payload-расширения до совместимых полей; overrides держать в policy/config | P1 | Риски: совместимость протокола/ивентов, стабильность UI/клиентов |
| NF-CORE-004 | core | [config/mod.rs.patch](release-audit/0.98/diff/codex-rs_core_src_config_mod.rs.patch)<br>[tool_allowlist.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tool_allowlist.rs.patch)<br>[tools_spec.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_spec.rs.patch)<br>[tools_registry.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_registry.rs.patch) | Tool allowlist/denylist (wildmatch), фильтрация registry/specs, “policy floor” для spawned agents | Upstream-native механизма нет; но концепт близок к upstream security posture | KEEP, но оформить как upstream-совместимую policy-модель (без завязки на registry) и документировать как security feature | P1 | Риск неожиданных пустых toolset’ов; нужно покрыть тестами комбинации allow/deny + agent profiles |
| NF-CORE-006 | core | [skills_remote.rs.patch](release-audit/0.98/diff/codex-rs_core_src_skills_remote.rs.patch)<br>[skills/mod.rs.patch](release-audit/0.98/diff/codex-rs_core_src_skills_mod.rs.patch) | Удалён remote skills downloader (сетевые запросы) | Upstream-native фича конфликтует с sandbox/network ограничениями; fork более безопасен | KEEP (fork-only): либо полностью отключено, либо возвращать только за явным флагом/feature и с явной моделью угроз | P1 | Риск потери функционала upstream; нужно подтвердить, что продукт не зависит от remote skills |
| NF-CORE-009 | core | [models_manager/manager.rs.patch](release-audit/0.98/diff/codex-rs_core_src_models_manager_manager.rs.patch)<br>[models_manager/model_info.rs.patch](release-audit/0.98/diff/codex-rs_core_src_models_manager_model_info.rs.patch) | Fork добавляет `experimental_supported_tools` (read_file/list_dir/grep_files) в локальные model defaults и “backfill” при пустых remote-данных | Upstream-native источник истины = remote model metadata; fork костыль компенсирует неполные remote ответы | Держать временно, но стремиться к upstream-native: починить/дождаться remote metadata и удалить backfill | P1 | Риск дрейфа: локальные дефолты могут не совпадать с реальными capabilities модели |
| NF-CORE-012 | core | [rollout/list.rs.patch](release-audit/0.98/diff/codex-rs_core_src_rollout_list.rs.patch)<br>[state_db.rs.patch](release-audit/0.98/diff/codex-rs_core_src_state_db.rs.patch) | Rollout/thread lookup: перестали предпочитать SQLite DB; файловый поиск стал canonical, а DB используется для parity-check и warning-ов | Upstream-native упирает на DB-ускорение; fork-дельта повышает корректность при stale DB ценой возможной деградации perf | Определить канонический источник истины (FS vs DB) и закрепить это тестами/метриками; если DB должен быть каноничным — вернуть upstream путь после стабилизации миграции | P1 | Риск: perf регрессия при листинге/поиске threads; “шумные” предупреждения о mismatch |
| NF-CORE-005 | core | [agents.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_handlers_agents.rs.patch)<br>[agent_tools.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_spec_agent_tools.rs.patch)<br>[handlers/mod.rs.patch](release-audit/0.98/diff/codex-rs_core_src_tools_handlers_mod.rs.patch) | Новые tools: `list_agents`/`read_agent` (доступ к локальному registry из модели) | Upstream-native можно было бы заменить “read_file + conventions”, но tool-API безопаснее/структурнее | KEEP (fork-only) как thin-layer над registry | P2 | Риск раскрытия инструкций (ожидаемо); уточнить политику scope (system/user/project) |
| NF-CORE-013 | core | [apply_patch runtime.patch](release-audit/0.98/diff/codex-rs_core_src_tools_runtimes_apply_patch.rs.patch) | `apply_patch` runtime теперь резолвит “invoker” бинарь (codex vs apply_patch) по `codex_exe` и окружению (в т.ч. когда invoker = `codex-linux-sandbox`) | Upstream-native чаще полагается на `current_exe`; fork-дельта выглядит как robustness fix для sandboxed окружений | KEEP; добавить регрессионные тесты на резолвинг invoker (особенно для `codex-linux-sandbox` и Windows) | P2 | Риск: tool может не запускаться при нестандартной раскладке бинарей; важно, чтобы резолвинг не позволял подмену запускаемого exe |
| NF-CORE-010 | core | [mcp_connection_manager.rs.patch](release-audit/0.98/diff/codex-rs_core_src_mcp_connection_manager.rs.patch) | Не блокировать `list_all_tools()` на старте `codex_apps_mcp` (используется `now_or_never`) | Upstream-native должен решать readiness/таймаутами, а не специальным кейсом | Либо upstream fix, либо общий механизм “soft readiness” для MCP клиентов | P2 | Риск: tools могут “пропадать” на ранних запросах; проверить наличие retry/refresh пути |
| NF-CORE-011 | core | [exec_env.rs.patch](release-audit/0.98/diff/codex-rs_core_src_exec_env.rs.patch) | Убран инжект `CODEX_THREAD_ID` в env для shell | Upstream-native может использовать это для трассировки/аудита; fork уменьшает утечки контекста в subprocess | Подтвердить, что thread-id не нужен downstream; иначе заменить upstream-native способом (structured logging/headers), не env | P2 | Риск потери корреляции в логах/скриптах |

### TUI

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-TUI-003 | tui | [streaming/mod.rs](release-audit/0.98/diff/codex-rs_tui_src_streaming_mod.rs.patch) [streaming/controller.rs](release-audit/0.98/diff/codex-rs_tui_src_streaming_controller.rs.patch) [D streaming/chunking.rs](release-audit/0.98/diff/codex-rs_tui_src_streaming_chunking.rs.patch) [D streaming/commit_tick.rs](release-audit/0.98/diff/codex-rs_tui_src_streaming_commit_tick.rs.patch) [chatwidget.rs](release-audit/0.98/diff/codex-rs_tui_src_chatwidget.rs.patch) | Убраны upstream adaptive chunking + commit_tick orchestration (queue timestamps, catch-up draining), commit tick упрощён до “1 line per tick” для stream+plan | Fork-дельта выглядит removable (upstream реализация богаче и снижает лаг при bursty output) | Native-first кандидат: вернуть upstream chunking/commit_tick и интеграцию с ChatWidget | P0 | Заметные UX/снапшот-изменения; тестить длинные стримы, backlog, plan+ответ одновременно |
| NF-TUI-001 | tui | [app.rs](release-audit/0.98/diff/codex-rs_tui_src_app.rs.patch) [app_backtrack.rs](release-audit/0.98/diff/codex-rs_tui_src_app_backtrack.rs.patch) [bottom_pane/footer.rs](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_footer.rs.patch) [footer shortcuts snap](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_snapshots_codex_tui_bottom_pane_footer_tests_footer_shortcuts_collaboration_modes_enabled.snap.patch) [collab.rs](release-audit/0.98/diff/codex-rs_tui_src_collab.rs.patch) | Multi-agent overlay: трекинг sub-agent threads, вывод summary/details, хоткей Ctrl+N (цикл summary→details→close), Ctrl+T оставлен под transcript pager | Upstream такого UI нет → убрать можно только ценой потери fork-ключевой фичи | Оставить fork-дельту; следить за конфликтами хоткеев/alt-screen и за флагом collaboration | P1 | Риск: сложность и “липкое” состояние overlay; проверить alt-screen + закрытие overlay в backtrack/preview режимах |
| NF-TUI-002 | tui | [chatwidget.rs](release-audit/0.98/diff/codex-rs_tui_src_chatwidget.rs.patch) [chatwidget/tests.rs](release-audit/0.98/diff/codex-rs_tui_src_chatwidget_tests.rs.patch) | Collaboration modes стартуют как `ModeKind::Custom` (инертно); не применяется upstream default preset/mask и не отправляется mode, пока юзер явно не выберет | Fork-отклонение от upstream поведения; потенциально можно вернуть native/upstream | Решение продуктовое: вернуть upstream default или оставить fork “не менять поведение молча” и явно подсветить выбор режима в UI | P1 | Риск: пользователю кажется, что collaboration modes “не работают” после включения |
| NF-TUI-006 | tui | [oss_selection.rs](release-audit/0.98/diff/codex-rs_tui_src_oss_selection.rs.patch) [tui/lib.rs](release-audit/0.98/diff/codex-rs_tui_src_lib.rs.patch) [app.rs](release-audit/0.98/diff/codex-rs_tui_src_app.rs.patch) | ✅ DONE (`2965b0bca`): удалён UX провайдера “Ollama (chat)” и связанный deprecation notice; OSS путь выровнен под Responses-only | Upstream этого не имеет; fork-функциональность завязана на fork OSS provider’ы | ✅ DONE (`2965b0bca`): Responses-only UX | P1 | Уменьшили дрейф и исключили потенциально флапающий детект/notice |
| NF-TUI-004 | tui | [tui/frame_rate_limiter.rs](release-audit/0.98/diff/codex-rs_tui_src_tui_frame_rate_limiter.rs.patch) [tui/frame_requester.rs](release-audit/0.98/diff/codex-rs_tui_src_tui_frame_requester.rs.patch) [pager_overlay.rs](release-audit/0.98/diff/codex-rs_tui_src_pager_overlay.rs.patch) [tui.rs](release-audit/0.98/diff/codex-rs_tui_src_tui.rs.patch) | Frame pacing: clamp 60 FPS (вместо 120), pager overlay просит кадр через 16ms, удалён TARGET_FRAME_INTERVAL | Потенциально можно вернуться к upstream константе/120fps ради снижения расхождений | Если нет измеримой пользы 60fps — откатиться к upstream; иначе оставить, но привязать к общей константе | P2 | Влияет на “ощущение” стриминга/скролла и на CPU; проверка должна быть ручной |
| NF-TUI-005 | tui | [request_user_input/mod.rs](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_request_user_input_mod.rs.patch) [request_user_input snap](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_request_user_input_snapshots_codex_tui_bottom_pane_request_user_input_tests_request_user_input_options_notes_visible.snap.patch) | UX/hotkeys: Esc в notes-mode теперь всегда `Interrupt` (раньше: “очистить notes и вернуться к options”), Tab очищает notes только при фокусе в notes | Upstream поведение можно вернуть, но fork-изменение кажется более консистентным с “Esc to interrupt” | Оставить fork (если цель — единый Esc=interrupt); иначе вернуть upstream “Esc cancels notes” и поправить подсказки | P2 | Риск: Esc может неожиданно прервать turn и потерять draft; обязательно проверить multi-question + notes |
| NF-TUI-007 | tui | [status/helpers.rs](release-audit/0.98/diff/codex-rs_tui_src_status_helpers.rs.patch) [status/card.rs](release-audit/0.98/diff/codex-rs_tui_src_status_card.rs.patch) [bottom_pane/footer.rs](release-audit/0.98/diff/codex-rs_tui_src_bottom_pane_footer.rs.patch) | History/status/footer: цветной индикатор “% context left” (red<15/yellow<30) | Можно убрать ради native-first (upstream проще), но дельта малорисковая и улучшает UX | Оставить как fork-улучшение, если принимаем визуальную семантику; иначе откатить к upstream строкам | P2 | Риск: доступность/темы терминала; снапшоты чувствительны к форматированию |
| NF-TUI-008 | tui | [cli.rs](release-audit/0.98/diff/codex-rs_tui_src_cli.rs.patch) [history_cell.rs](release-audit/0.98/diff/codex-rs_tui_src_history_cell.rs.patch) [status/card.rs](release-audit/0.98/diff/codex-rs_tui_src_status_card.rs.patch) [update_prompt.rs](release-audit/0.98/diff/codex-rs_tui_src_update_prompt.rs.patch) [resume_picker.rs](release-audit/0.98/diff/codex-rs_tui_src_resume_picker.rs.patch) | Форк-брендинг версии: “FN” префиксы/суффиксы в CLI/help, status card, update prompt, history cells, тестах | Это сознательная fork-идентификация; native-first откат возможен, но тогда теряется различимость | Оставить; унифицировать формат (префикс/суффикс без лишних пробелов) при следующих правках | P2 | Риск: строки версии могут парситься внешними тулзами/тестами; снапшоты чувствительны |
| NF-TUI-009 | tui | [debug_config.rs](release-audit/0.98/diff/codex-rs_tui_src_debug_config.rs.patch) | Debug config: для ряда требований больше не показывается “source” (становится `<unspecified>`), тесты переписаны | Убрать дельту можно только если core снова несёт source-метаданные; иначе это вынужденная адаптация | Оставить как совместимость с fork-core; рассмотреть возврат source при восстановлении API в core | P2 | Риск: ухудшение диагностичности |
| NF-TUI-010 | tui | [history_cell.rs](release-audit/0.98/diff/codex-rs_tui_src_history_cell.rs.patch) | Runtime metrics: убраны строки “Responses API overhead/inference” из separator label | Похоже removable: upstream метрики полезны, если в fork они корректны | Решить по факту: вернуть upstream строки или оставить скрытыми (если шумят) | P2 | Риск: потеря observability в UI; проверить наличие метрик в реальных сессиях |

### Protocol

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-PROTO-001 | protocol | [common.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_common.rs.patch)<br>[v2.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_v2.rs.patch)<br>[protocol.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_protocol.rs.patch) | ✅ DONE (`e692cb2e9`): возвращены RPC `skills/remote/read|write` и типы для surface-compat в app-server протоколе; по дефолту server возвращает явную ошибку (disabled-by-policy) и не делает network egress. Core remote downloader/`Op`/`EventMsg` остаются удалены (по решению D5). | Upstream-native уже покрывает “skills” локально; “remote sharing” лучше делать вне протокола | ✅ DONE (`e692cb2e9`): держать surface-compat RPC, но оставлять remote skills функционально отключёнными по политике (явная ошибка). | P0 | Breaking по отсутствию методов mitigated: методы существуют, но возвращают policy error; клиенты должны уметь обрабатывать “disabled by policy” |
| NF-PROTO-003 | protocol | [export.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_export.rs.patch)<br>[v2.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_v2.rs.patch) | ✅ DONE (`89c00611c`): TS-codegen: запрет `?: T | null` (и `| undefined`), массовая правка `#[ts(optional = nullable)]` | Upstream-native: строгий TS-контракт без “optional+nullable” | ✅ DONE (`89c00611c`): принять как базовое правило; точечно решать поля: где реально “можно omit” — переводить в `#[ts(optional)]`, иначе `T | null` | P0 | Возможен компиляционный break для TS-клиентов (теперь многие поля “required, nullable”) |
| NF-PROTO-004 | protocol | [config_types.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_config_types.rs.patch) | ✅ DONE (`e692cb2e9`): `ModeKind::Custom` — внутренний sentinel; исключён из schemars/TS exports и не появляется on-wire (сериализуется как `default`, `\"custom\"` на входе маппится в `Default`). | Fork-дельта `Custom` в on-wire протоколе часто можно выразить upstream-native через `developer_instructions` без нового `mode` | ✅ DONE (`e692cb2e9`): не расширять публичный протокол значением `custom`; гарантировать, что `custom` не сериализуется наружу. | P0 | Риск on-wire несовместимости устранён: сериализация/rollout не падают, `custom` не уходит наружу |
| NF-PROTO-007 | protocol | [protocol.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_protocol.rs.patch) | ✅ DONE (`f731f3db0`): SandboxPolicy: `.agents` добавлен обратно в `read_only_subpaths` (вместе с `.git` и `.codex`) | Fork-специфика: если форк реально использует `.agents/**` для инструкций/skill-asset’ов, upstream-native защита могла быть важна | ✅ DONE (`f731f3db0`): вернуть `.agents` в read-only | P0 | Потенциальная секьюрити-регрессия: агент сможет писать в `.agents/**` при разрешённой записи в workspace |
| NF-PROTO-002 | protocol | [common.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_common.rs.patch)<br>[v2.rs.patch](release-audit/0.98/diff/codex-rs_app-server-protocol_src_protocol_v2.rs.patch) | ✅ DONE (`e692cb2e9`): RPC `thread/compact/start` и его Params/Response возвращены для surface-compat (прогресс идёт через стандартные turn/item notifications). | “Compaction” уже выражается через существующие события/механику без отдельного старт-метода | ✅ DONE (`e692cb2e9`): поддерживать RPC `thread/compact/start` (surface-compat). | P1 | Риск breaking по отсутствию метода снят; остаётся проверить/задокументировать ожидания клиентов по стриму прогресса |
| NF-PROTO-005 | protocol | [config_types.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_config_types.rs.patch)<br>[openai_models.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_openai_models.rs.patch) | Удалён `Personality::None` (теперь “нет personality” выражается отсутствием значения) | Upstream-native: `Option<Personality>` несёт “none” без отдельного enum-варианта | Ок принять; для совместимости конфигов рассмотреть alias/миграцию на уровне парсинга | P1 | Breaking для старых `config.toml`, где было `personality = \"none\"` |
| NF-PROTO-006 | protocol | [protocol.rs.patch](release-audit/0.98/diff/codex-rs_protocol_src_protocol.rs.patch) | Добавлены `agent_type/agent_name` в `SubAgentSource::ThreadSpawn` и `CollabAgentSpawnEndEvent` | Native-first: совпадает с upstream-концептом `agent_type/agent_name` в tool schema, улучшает наблюдаемость | Оставить поля опциональными; клиенты должны игнорировать неизвестные поля | P1 | Минимальный wire-риск (поля optional), но нужно проверить все потребители событий/логов |
| NF-PROTO-008 | protocol | [on_request_rule.md.patch](release-audit/0.98/diff/codex-rs_protocol_src_prompts_permissions_approval_policy_on_request_rule.md.patch) | Обновлён текст approval-policy: `prefix_rule` теперь “Suggest …”, переформатирован блок про approved prefixes | Это не протокольное расширение, а правка prompt/инструкций | Принять как doc/prompt-апдейт; проверить, что нет brittle парсинга текста | P2 | Риск только если где-то есть парсинг текста как структуры |

### Linux sandbox

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-LS-001 | linux-sandbox | [exec_policy.rs.patch](release-audit/0.98/diff/codex-rs_core_src_exec_policy.rs.patch) | ✅ DONE (`73681a6e5`, `5ab253881`): `.codex/rules` из trust-disabled project layer больше не грузятся | См. NF-CORE-007 (тот же риск/решение) | ✅ DONE (`73681a6e5`, `5ab253881`) | P0 | Дубликат карточки NF-CORE-007 (оставлено для маршрутизации sandbox review) |
| NF-LS-003 | linux-sandbox | [linux-sandbox/build.rs.patch](release-audit/0.98/diff/codex-rs_linux-sandbox_build.rs.patch)<br>[linux-sandbox/Cargo.toml.patch](release-audit/0.98/diff/codex-rs_linux-sandbox_Cargo.toml.patch)<br>[vendored bubblewrap patches](release-audit/0.98/diff/codex-rs_vendor_bubblewrap_bubblewrap.c.patch) | Удалён build-time pipeline для vendored bubblewrap (и сам vendor tree), т.е. путь “встроенный bwrap через FFI” фактически исчез | Upstream “vendored bwrap” закрывает use-case воспроизводимости/бандлинга; форк-дельта может превратить `use_bwrap_sandbox` в footgun | Либо вернуть upstream vendored-bwrap pipeline, либо полностью выпилить/задокументировать неработающий bwrap-path и перейти на exec системного `bwrap` с явными проверками наличия | P1 | Риск: при включении bwrap-фичи возможен runtime panic/неработающий sandbox; есть лицензионные/NOTICE аспекты (см. NF-META-005) |
| NF-LS-002 | linux-sandbox | [exec_env.rs.patch](release-audit/0.98/diff/codex-rs_core_src_exec_env.rs.patch)<br>[debug_sandbox.rs.patch](release-audit/0.98/diff/codex-rs_cli_src_debug_sandbox.rs.patch)<br>[landlock.rs test.patch](release-audit/0.98/diff/codex-rs_linux-sandbox_tests_suite_landlock.rs.patch) | Убран `CODEX_THREAD_ID` в env и упрощён `create_env(...)` | Upstream-эквивалент не нужен для sandbox; изменение скорее про “меньше скрытых env” vs корреляция/диагностика | Вернуть upstream-поведение, если thread-id реально нужен; иначе оставить, но зафиксировать в ожиданиях/доках | P2 | Риск: потеря корреляции/диагностики (см. NF-CORE-011) |

### Meta (templates / docs / ci / vendor)

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-META-005 | meta | [bubblewrap.c.patch](release-audit/0.98/diff/codex-rs_vendor_bubblewrap_bubblewrap.c.patch) (и `codex-rs_vendor_bubblewrap_*.patch`) | Удалён целиком `codex-rs/vendor/bubblewrap/**` | Native-first “за” удаление vendoring, но только если сборка/упаковка bwrap больше не завязана на эти исходники и закрыты license/NOTICE обязательства | Перед релизом подтвердить цепочку: как теперь обеспечивается bubblewrap (system dependency vs артефакт) + актуализировать упоминания `vendored` путей в доках/ошибках | P0 | Риск: Linux sandbox bwrap pipeline может сломаться (см. NF-LS-003); лицензионные/NOTICE обязательства; supply-chain |
| NF-META-002 | meta | [codex_architect.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_architect.md.patch) [codex_bug-hunter.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_bug-hunter.md.patch) [codex_explorer.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_explorer.md.patch) [codex_orchestrator.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_orchestrator.md.patch) [codex_reviewer.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_reviewer.md.patch) [codex_worker.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_codex_worker.md.patch) [agents/orchestrator.md.patch](release-audit/0.98/diff/codex-rs_core_templates_agents_orchestrator.md.patch) | Добавлены “встроенные” профили агентов `codex_*.md` + YAML-frontmatter; `agents/orchestrator.md` получил frontmatter | Зона высокого дрейфа: тексты шаблонов частично дублируют глобальные инструкции; сложно синхронизировать с upstream | Оставить только то, что реально fork-специфично; остальное — ссылками/наследованием, чтобы снизить churn | P1 | Риски: prompt-drift (модели/reasoning/tools), “двойной источник правды” (шаблоны vs AGENTS/docs) |
| NF-META-003 | meta | [experimental_prompt.md.patch](release-audit/0.98/diff/codex-rs_core_templates_collab_experimental_prompt.md.patch) [collaboration_mode_code.md.patch](release-audit/0.98/diff/codex-rs_core_templates_collaboration_mode_code.md.patch) | Существенно расширен runtime prompt про sub-agents; добавлен минимальный `collaboration_mode/code.md` | Native-first: держать runtime prompt максимально upstream-каноничным; fork-дополнения — по минимуму/в отдельной fork-доке | Не наращивать кастомизации; fork-поведение фиксировать в коде/фича-флагах и `docs/fork/*`, а не “много текста” в prompt | P1 | Риск: поведенческие изменения multi-agent режима через контент, сложнее отлаживать регрессии |
| NF-META-001 | meta | [.github templates](release-audit/0.98/diff/R_.github_ISSUE_TEMPLATE_3-cli.yml_TO_.github_ISSUE_TEMPLATE_2-bug-report.yml.patch) | Консолидация issue templates (унификация bug report; переименование VS Code; удаление части шаблонов) | Native-first ок: процессные изменения, низкий риск | Держать; проверить, что нет ссылок/автоматизаций на удалённые шаблоны | P2 | Риск: UX/триаж по лейблам; ссылки в CONTRIBUTING/README (если есть) |
| NF-META-004 | meta | [docs/fork patch](release-audit/0.98/diff/docs_fork_diff-fork-vs-main.md.patch) (и прочие `docs_fork_*.patch`) | Добавлен набор fork-доков (процесс интеграции, аудит diff, список upstream-коммитов и т.п.) | Native-first: возможны дубли и дорогое поддержание больших “дифф-репортов” | Оставить fork-доки, но стремиться к “тонкому слою”: 1 основной документ + ссылки; большие отчёты держать в release-audit/генерации | P2 | Риск: устаревание/рассинхрон; поддержка “тысячи строк” дорогая |

### codex-api

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-CODEX-API-001 | codex-api | [provider.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_provider.rs.patch)<br>[endpoint/chat.rs rename](release-audit/0.98/diff/R_codex-rs_codex-api_src_endpoint_aggregate.rs_TO_codex-rs_codex-api_src_endpoint_chat.rs.patch)<br>[requests/chat.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_requests_chat.rs.patch)<br>[sse/chat.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_sse_chat.rs.patch)<br>[endpoint/responses.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_endpoint_responses.rs.patch)<br>[README.md.patch](release-audit/0.98/diff/codex-rs_codex-api_README.md.patch) | ✅ DONE (`2965b0bca`): удалён Chat Completions wire (WireApi::Chat) и wire-switch; `ResponsesClient` всегда использует `/v1/responses` | Upstream 0.98 ориентирован на Responses-only; fork-ветка “chat wire” увеличивает дрейф и площадь регрессий | ✅ DONE (`2965b0bca`): Responses-only (upstream) | P0 | Снижен дрейф транспорта; остаётся следить за websocket/SSE parity (см. NF-CODEX-API-003) |
| NF-CODEX-API-002 | codex-api | [endpoint/streaming.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_endpoint_streaming.rs.patch)<br>[D endpoint/session.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_endpoint_session.rs.patch)<br>[endpoint/responses.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_endpoint_responses.rs.patch)<br>[endpoint/compact.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_endpoint_compact.rs.patch)<br>[endpoint/models.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_endpoint_models.rs.patch)<br>[endpoint/memories.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_endpoint_memories.rs.patch)<br>[auth.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_auth.rs.patch) | Удалён `EndpointSession`, добавлен `StreamingClient`, а unary-запросы теперь строятся вручную в каждом клиенте; auth helper переписан под “вернуть Request с заголовками” | Upstream-native выглядит проще/менее дублирующимся (единый session helper); fork-рефактор оправдан в основном как следствие split wire (Responses vs Chat) | Если Chat-wire остаётся: минимизировать duplication (общий helper для unary). Если Chat-wire убираем: откатиться ближе к upstream `EndpointSession` | P1 | Риск дрейфа поведения между клиентами (headers/retry/query params), выше стоимость будущих апгрейдов |
| NF-CODEX-API-003 | codex-api | [responses_websocket.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_endpoint_responses_websocket.rs.patch)<br>[rate_limits.rs.patch](release-audit/0.98/diff/codex-rs_codex-api_src_rate_limits.rs.patch) | Websocket-стрим перестал эмитить `ResponseEvent::ModelsEtag` и перестал парсить `codex.rate_limits` из websocket payload; удалён `parse_rate_limit_event` | Upstream-native отдаёт эти события; fork-урезание снижает observability/реактивные обновления (etag refresh/rate limit state) | Вернуть upstream-семантику для websocket (etag + rate_limits) или явно зафиксировать, что эти события гарантируются только через SSE (и проверить потребителей) | P1 | Риск тихой деградации при websocket-first transport |

### app-server-test-client

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-APP-SERVER-TEST-CLIENT-001 | app-server-test-client | [BUILD.bazel.patch](release-audit/0.98/diff/codex-rs_app-server-test-client_BUILD.bazel.patch)<br>[D src/lib.rs.patch](release-audit/0.98/diff/codex-rs_app-server-test-client_src_lib.rs.patch)<br>[main.rs.patch](release-audit/0.98/diff/codex-rs_app-server-test-client_src_main.rs.patch) | Переименование bazel-target под `codex-*` + перевод утилиты в “bin-only” (удалён lib.rs, логика в main.rs) | Upstream-native может хотеть lib для переиспользования; fork-изменение в основном про packaging/конвенции | Оставить только если реально нужен bin-only и naming consistency; иначе вернуть upstream-структуру (lib + тонкий main) | P2 | Низкорисково, но влияет на потребителей (если кто-то импортировал библиотеку) и на bazel targets |

### app-server

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-APP-SERVER-001 | app-server | [codex_message_processor.rs.patch](release-audit/0.98/diff/codex-rs_app-server_src_codex_message_processor.rs.patch)<br>[mcp_process.rs.patch](release-audit/0.98/diff/codex-rs_app-server_tests_common_mcp_process.rs.patch)<br>[v2/compaction.rs.patch](release-audit/0.98/diff/codex-rs_app-server_tests_suite_v2_compaction.rs.patch)<br>[README.md.patch](release-audit/0.98/diff/codex-rs_app-server_README.md.patch) | ✅ DONE (`e692cb2e9`): JSON-RPC `thread/compact/start` возвращён (manual trigger compaction) + восстановлены хелперы/тесты/дока. | Upstream-native может выражать compaction через существующие turn/review механики без отдельного RPC | ✅ DONE (`e692cb2e9`): держать `thread/compact/start` ради surface-compat; прогресс должен стримиться через стандартные turn/item notifications. | P0 | Breaking для клиентов по отсутствию RPC снят; остаётся следить за стабильностью стрима событий |
| NF-APP-SERVER-002 | app-server | [codex_message_processor.rs.patch](release-audit/0.98/diff/codex-rs_app-server_src_codex_message_processor.rs.patch)<br>[README.md.patch](release-audit/0.98/diff/codex-rs_app-server_README.md.patch) | ✅ DONE (`e692cb2e9`): JSON-RPC `skills/remote/read|write` возвращены для surface-compat, но по дефолту **disabled-by-policy** (явная ошибка; без network egress). | Upstream-native “remote skills sharing” лучше делать вне app-server протокола; форк снижает сетевую поверхность | ✅ DONE (`e692cb2e9`): держать методы в surface, но оставлять функционал отключённым по политике (явная ошибка). | P0 | Клиенты должны уметь обрабатывать policy error; функционал remote skills намеренно не включён |
| NF-APP-SERVER-003 | app-server | [src/models.rs.patch](release-audit/0.98/diff/codex-rs_app-server_src_models.rs.patch)<br>[v2/model_list.rs.patch](release-audit/0.98/diff/codex-rs_app-server_tests_suite_v2_model_list.rs.patch)<br>[README.md.patch](release-audit/0.98/diff/codex-rs_app-server_README.md.patch) | ✅ DONE (`e692cb2e9`): `model/list` снова возвращает optional `upgrade` (совместимо с типизированными клиентами). | Upstream-native контракт без этого поля; fork-изменение потенциально ломает типизированных клиентов | ✅ DONE (`e692cb2e9`): возвращать optional `upgrade` (как в upstream surface). | P0 | Breaking для клиентов по отсутствию поля снят; следить за backwards-compat (omit vs null) |
| NF-APP-SERVER-004 | app-server | [v2/turn_start.rs.patch](release-audit/0.98/diff/codex-rs_app-server_tests_suite_v2_turn_start.rs.patch) | ✅ DONE (`e692cb2e9`): `ModeKind::Custom` не появляется on-wire; override collaboration mode использует `Default` (см. также NF-PROTO-004). | Upstream-native чаще избегает on-wire “custom” (см. NF-PROTO-004) | ✅ DONE (`e692cb2e9`): не сериализовать `ModeKind::Custom` наружу. | P0 | Риск несовместимости по on-wire “custom” устранён |
| NF-APP-SERVER-005 | app-server | [filters.rs.patch](release-audit/0.98/diff/codex-rs_app-server_src_filters.rs.patch)<br>[v2/thread_list.rs.patch](release-audit/0.98/diff/codex-rs_app-server_tests_suite_v2_thread_list.rs.patch) | `SubAgentSource::ThreadSpawn` расширен полями `agent_type`/`agent_name` (оба Option) | Native-first: это улучшение наблюдаемости, совместимо при optional-полях | Оставить поля optional; клиенты игнорируют неизвестные поля | P1 | Нужно проверить всех потребителей событий/логов |
| NF-APP-SERVER-006 | app-server | [v2/review.rs.patch](release-audit/0.98/diff/codex-rs_app-server_tests_suite_v2_review.rs.patch)<br>[tests/common/rollout.rs.patch](release-audit/0.98/diff/codex-rs_app-server_tests_common_rollout.rs.patch)<br>[user_agent.rs.patch](release-audit/0.98/diff/codex-rs_app-server_tests_suite_user_agent.rs.patch) | Тестовые/метаданные изменения: ослабление e2e проверки approvals в `review.rs`; в assertions и UA-строке `cli_version` берётся из `env!(\"CARGO_PKG_VERSION\")` вместо фиктивного `0.0.0` | Не про native-first: это “aудит тестов/наблюдаемого контракта” | Оставить, но компенсировать: вернуть или добавить эквивалентную проверку approvals в другом e2e; договориться, что `cli_version` является стабильной частью on-wire/логов | P2 | Риск скрыть регрессию approvals (меньше тест-ассёртов); возможно ломает потребителей, которые ожидали `0.0.0` |

### windows-sandbox-rs

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-WIN-SB-001 | windows-sandbox-rs | [cap.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_cap.rs.patch)<br>[setup_main_win.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_setup_main_win.rs.patch)<br>[elevated_impl.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_elevated_impl.rs.patch)<br>[lib.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_lib.rs.patch)<br>[D workspace_acl.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_workspace_acl.rs.patch) | Удаляется per-workspace capability SID keyed by CWD; workspace-write больше не получает “доп. cap SID на CWD”, убрана защита `CWD/.codex` deny-ACE; payload больше не несёт `command_cwd` | Это меняет security boundary; upstream-native упрощение допустимо только если модель угроз сохранена | Требуется явное подтверждение, что модель безопасности не ухудшилась; если ухудшилась, вернуть upstream/более строгий вариант | P0 | Риск изменения изоляции/прав в Windows sandbox |
| NF-WIN-SB-002 | windows-sandbox-rs | [token.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_token.rs.patch)<br>[command_runner_win.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_command_runner_win.rs.patch) | API токенов меняется с “many caps” на “single cap”; `CreateRestrictedToken` получает ровно 3 SID’а (Capability, Logon, Everyone) | Upstream-native возможно стремится к более простой модели; нужно подтвердить поведение в реальных сценариях | Оставить при наличии регрессионных тестов/проверок; иначе откатить к upstream multi-cap | P0 | Критично для корректности запуска и ограничения прав |
| NF-WIN-SB-003 | windows-sandbox-rs | [audit.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_audit.rs.patch)<br>[D path_normalization.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_path_normalization.rs.patch)<br>[setup_orchestrator.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_setup_orchestrator.rs.patch) | Удалён `path_normalization.rs`, введён `audit::normalize_path_key()`; используется для дедупликации и блокировки sensitive roots (`CODEX_HOME/.sandbox*`) | Upstream-native консолидация нормализации ок, если ключи стабильны | Оставить, но добавить тесты на нормализацию (case, separators) | P1 | Риск пропуска/ложных совпадений при фильтрации путей |
| NF-WIN-SB-004 | windows-sandbox-rs | [acl.rs.patch](release-audit/0.98/diff/codex-rs_windows-sandbox-rs_src_acl.rs.patch) | В deny-write маске убраны `DELETE` и `FILE_DELETE_CHILD` | Upstream-native может предпочитать менее агрессивный deny | Оставить если это намеренное ослабление; иначе вернуть delete-биты | P2 | Может менять deny semantics на директориях/файлах |

### exec + mcp-server

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-EXEC-001 | exec | [event_processor_with_human_output.rs.patch](release-audit/0.98/diff/codex-rs_exec_src_event_processor_with_human_output.rs.patch)<br>[event_processor_with_jsonl_output.rs.patch](release-audit/0.98/diff/codex-rs_exec_src_event_processor_with_jsonl_output.rs.patch) | `TurnAborted` больше не триггерит `InitiateShutdown` в output processors | Upstream-native может менять семантику “abort == shutdown”; нужно подтвердить ожидания CLI | Зафиксировать выбранную семантику (abort vs shutdown), добавить тест/доку по exit codes | P0 | Может поменять “immortal exec”/завершение процесса и UX |
| NF-MCP-001 | mcp-server | [mock_model_server.rs.patch](release-audit/0.98/diff/codex-rs_mcp-server_tests_common_mock_model_server.rs.patch)<br>[suite/codex_tool.rs.patch](release-audit/0.98/diff/codex-rs_mcp-server_tests_suite_codex_tool.rs.patch) | ✅ DONE (`901e3488c`): MCP tests — mock model server и suite переведены обратно на `/v1/responses` SSE | Upstream-native 0.98 предпочитает Responses; fork-дельта сигнализирует смену транспорта/контракта в тестах | ✅ DONE (`901e3488c`): Responses-only тестовый wire | P0 | Сняли дрейф тестовой инфраструктуры и транспорта |
| NF-EXEC-002 | exec | [cli.rs.patch](release-audit/0.98/diff/codex-rs_exec_src_cli.rs.patch)<br>[lib.rs.patch](release-audit/0.98/diff/codex-rs_exec_src_lib.rs.patch) | ✅ DONE (`2965b0bca`): убраны упоминания `ollama-chat`, детект chat wire и `DeprecationNotice` (Responses-only) | Upstream-native может не иметь OSS провайдеров; fork-дельта продуктовая | ✅ DONE (`2965b0bca`): Responses-only | P2 | Уменьшили дрейф/UX-ветвления вокруг OSS |
| NF-EXEC-003 | exec + mcp-server | [mcp tool runner](release-audit/0.98/diff/codex-rs_mcp-server_src_codex_tool_runner.rs.patch)<br>[human output processor](release-audit/0.98/diff/codex-rs_exec_src_event_processor_with_human_output.rs.patch) | Синхронизация с удалением remote skills: удаляются/перестают отдельно игнорироваться события `ListRemoteSkillsResponse`/`RemoteSkillDownloaded` | Native-first: если upstream-функционал remote skills убран/загейтован, то это корректно | Зафиксировать, что remote skills events/потоки отсутствуют, и не держать “мёртвые” обработчики; убедиться, что ручные проверки/доки не требуют remote skills | P2 | Риск: если где-то ещё ожидают эти события, поведение станет “unknown event”; но это скорее признак несовместимости контрактов |

### state / otel / secrets

| Card | Area | Files (patch) | Fork delta (что изменили) | Native-first assessment | Recommendation | Priority | Risks/Notes |
|---|---|---|---|---|---|---|---|
| NF-STATE-001 | state | [runtime.rs.patch](release-audit/0.98/diff/codex-rs_state_src_runtime.rs.patch)<br>[lib.rs.patch](release-audit/0.98/diff/codex-rs_state_src_lib.rs.patch) | Переход на фиксированное имя файла `state.sqlite` (вместо `state_<ver>.sqlite`), удаление логики чистки legacy файлов | Upstream-native может быть проще, но требует миграции/совместимости | Добавить явную миграцию/поиск legacy имени или четко задокументировать breaking | P0 | Риск “потерять” существующую DB при апгрейде |
| NF-STATE-002 | state | [runtime.rs.patch](release-audit/0.98/diff/codex-rs_state_src_runtime.rs.patch) | `thread_dynamic_tools`: если у thread уже есть запись, новые tools больше не вставляются | Upstream-native поведение может быть позиционным; форк меняет семантику | Подтвердить контракт и добавить тесты на обновление dynamic tools | P0 | Риск “залипших” инструментов в persisted state |
| NF-STATE-003 | state | [extract.rs.patch](release-audit/0.98/diff/codex-rs_state_src_extract.rs.patch) | `extract.rs`: user-сообщения из `ResponseItem::Message` теперь влияют на `ThreadMetadata` (например title/has_user_event); фильтрация local-image tag-ов | Upstream-native = улучшение метаданных; fork-дельта вероятно корректна, но меняет наблюдаемое поведение | Зафиксировать контракт `ThreadMetadata` и покрыть тестом (title derivation + has_user_event + фильтрация image tags) | P1 | Риск регрессий в UI/листинге threads из-за смены title/метаданных |
| NF-STATE-004 | state | [logs_client.rs.patch](release-audit/0.98/diff/codex-rs_state_src_bin_logs_client.rs.patch) | `codex-state-logs`: путь к DB теперь явно `CODEX_HOME/state.sqlite`, help/description обновлены | Native-first: мелкая синхронизация с новой схемой хранения | Оставить; убедиться, что нет скрытых consumers, ожидающих старое имя файла | P2 | Низкий риск, но легко забыть при миграции |
| NF-OTEL-001 | otel | [metrics/names.rs.patch](release-audit/0.98/diff/codex-rs_otel_src_metrics_names.rs.patch)<br>[metrics/runtime_metrics.rs.patch](release-audit/0.98/diff/codex-rs_otel_src_metrics_runtime_metrics.rs.patch)<br>[traces/otel_manager.rs.patch](release-audit/0.98/diff/codex-rs_otel_src_traces_otel_manager.rs.patch) | Удалены метрики и парсинг websocket-события `responsesapi.websocket_timing` | Upstream-native может быть полезнее для диагностики; fork-дельта снижает observability | Либо вернуть метрики, либо зафиксировать, что timing не поддерживается | P2 | Потеря диагностики по websocket timing |
| NF-SECRETS-001 | secrets | [D secrets/Cargo.toml.patch](release-audit/0.98/diff/codex-rs_secrets_Cargo.toml.patch)<br>[D secrets/src/lib.rs.patch](release-audit/0.98/diff/codex-rs_secrets_src_lib.rs.patch)<br>[D secrets/src/local.rs.patch](release-audit/0.98/diff/codex-rs_secrets_src_local.rs.patch) | Полностью удалён crate `codex-rs/secrets` (локальный backend + manager/types) | Если upstream от этого отказался, ок; но нужно убедиться, что нигде не остались интеграции | Зафиксировать удаление и проверить все зависимости/доки/флаги | P1 | Риск hidden dependency или планируемой фичи, которая теперь исчезла |
